
<!doctype html>
<html lang="en">
<head>



<script th:include="components/header :: headerLibrary" th:remove="tag"></script>

</head>
<body ng-app="application">
	<script>
		var main = angular.module('application', [ 'infinite-scroll' ]);

		main.controller('searchController', function($scope, $http, postService, messageService) {

			$scope.shared = messageService.getShared();
			
			$scope.search = function() {
				console.log($scope.keyword);
				if ($scope.keyword) {
					$http({
						url : "/post/searchPosts",
						method : "POST",
						headers : {
							'Content-Type' : 'application/json'
						},
						data : {
							keyword : $scope.keyword
						}
					}).then(function(response) {
						if (response.data.postList) {
							$scope.message("found " + response.data.postList.length + " records");
							$scope.postList = response.data.postList;
						} else {
							$scope.message("no records found");
						}

					});
				}
			}
			var handleResponse = function(response, type) {
				if (response.data.status == 'success') {
					$scope.message(type + " success");
				} else {
					$scope.message(type + " failed : " + response.data.remarks);
				}
			}

			$scope.likePost = function(postId) {
				postService.likePost(postId).then(function(response) {
					//handleResponse(response, 'like');
				});
			}

			$scope.retweetPost = function(postId) {
				postService.retweetPost(postId).then(function(response) {
					handleResponse(response, 'retweet');
				});
			}

			$scope.removePost = function(postId) {
				if (confirm("Remove this post?")) {
					postService.removePost(postId).then(function(response) {
						handleResponse(response, 'remove');
					});
				}
			}
			$scope.message = function(message) {
				messageService.setMessage(message);
			}

		});

		main.controller('viewPostController', function($scope, postService, messageService) {
			$scope.postList = postService.postList;
			
			postService.setMessageService(messageService);
			
			$scope.likePost = function(postId){ postService.likePost(postId); }
			$scope.retweetPost = function(postId){ postService.retweetPost(postId); }
			$scope.removePost = function(postId){ postService.removePost(postId); }
			$scope.loadPost = function() { postService.loadPosts("getLatestPosst"); }

			$scope.loadPost();
			
			$scope.shared = messageService.getShared();

			$scope.$watch('shared.user', function(newValue, oldValue) {
				if (newValue != oldValue) {
					$scope.loadPost();
				}
			});

		});
	</script>
	<div th:include="components/post :: viewPostScript" th:remove="tag"></div>

	<div th:include="components/header :: headerScript" th:remove="tag"></div>
	<div th:include="components/header :: headerBody" th:remove="tag"></div>

	<div class="container">
		<div ng-controller="searchController" class="row m-5">

			<div class="form-inline">
				<h3>Search</h3>
				&nbsp;
				<form ng-submit="search()">
					<input class="form-control mr-sm-2" type="text" ng-model="keyword" />
					<button class="form-control mr-sm-2" type="submit">Search</button>
				</form>
			</div>
			<div ng-show="postList" class="row-m5">
				<h3>Search Result</h3>
				<div ng-repeat="post in postList | filter: {removed : false}" class="card col-md-3 m-1">
					<div th:include="components/post :: viewPosts('thumbnail')" th:remove="tag"></div>
				</div>
			</div>
		</div>
		<h3 class="row m-5">Latest 20 Post</h3>
		<div ng-controller="viewPostController" class="row m-5">

			<div ng-repeat="post in postList | filter: {removed : false}" class="card col-md-3 m-1">
				<div th:include="components/post :: viewPosts('thumbnail')" th:remove="tag"></div>
			</div>
		</div>

	</div>
	<hr>

	<footer>
		<p>&copy; Company 2013</p>
	</footer>

</body>
</html>