<!doctype html>
<html lang="en">
<head>

<script th:include="components/header :: headerLibrary" th:remove="tag"></script>

<script src="/js/ng-flow-standalone.min.js"></script>

</head>
<body ng-app="application">
	<script>
		var main = angular.module('application', [ 'flow' ]);

		main.controller('settingController', function($scope, $http, messageService) {
			$scope.shared = messageService.getShared();

			$scope.obj = {};

			$http({
				url : "/user/getUser/[[${targetUser?.userId}]]",
				method : "GET",
				headers : {
					'Content-Type' : 'application/json'
				}
			}).then(function(response) {
				if (response.data.status == 'success') {
					if (response.data.user.profileImage[0]) {
						$scope.profileImage = response.data.user.profileImage[0].filename;
					}

					$scope.uniqueName = response.data.user.uniqueName;
					$scope.checkName = response.data.user.uniqueName;

					$scope.profileMessage = response.data.user.message;
				} else {
					$scope.message("Load User Failed");
				}
			});

			$scope.checkUniqueName = function() {
				if ($scope.uniqueName != $scope.checkName) {
					$http({
						url : "/user/checkUniqueName/",
						method : "POST",
						headers : {
							'Content-Type' : 'application/json'
						},
						data : {
							uniqueName : $scope.uniqueName
						}
					}).then(function(response) {
						if (response.data.status == 'success') {
							$scope.uniqueNameMessage = "OK";
						} else {
							$scope.uniqueNameMessage = "someone using this name already";
						}
					});
				}
			}

			$scope.submit = function() {
				var image;

				angular.forEach($scope.obj.flow.files, function(value, key) {
					var msg = JSON.parse(value.msg);
					if (msg.status === 'success') {
						image = msg.filePath;
					}
				});

				$http({
					url : "/user/updateSetting/",
					method : "POST",
					headers : {
						'Content-Type' : 'application/json'
					},
					data : {
						password : $scope.password,
						uniqueName : $scope.uniqueName,
						message : $scope.profileMessage,
						image : image
					}
				}).then(function(response) {
					if (response.data.status == 'success') {
						$scope.password = null;
						$scope.message(response.data.remarks);
					} else {
						$scope.message(response.data.remarks);
					}
				});
			}

			$scope.message = function(message) {
				messageService.setMessage(message);
			}
		});
	</script>

	<div th:include="components/header :: headerScript" th:remove="tag"></div>
	<div th:include="components/header :: headerBody" th:remove="tag"></div>

	<div class="container" ng-controller="settingController">
		<form ng-submit="submit()">
			<h3>Settings</h3>
			<div class="row">
				<div class="col-md-4 form-inline p-2">
					<input type="password" ng-model="password" name="password" placeholder="Password" class="form-control" /> <input type="submit" id="update" value="update" class="btn btn-primary form-control" />
				</div>
			</div>
			<div class="row">

				<table class="table">
					<tr>
						<td class="span3">Profile Image :</td>
						<td>
							<div flow-init="{target: '/user/uploadProfileImage', testChunks:false, singleFile:true, chunkSize : 10000000}" flow-files-submitted="$flow.upload()" flow-file-success="$file.msg = $message" flow-file-added="!!{png:1,jpg:1,jpeg:1}[$file.getExtension()];validate($file)" flow-name="obj.flow">

								<div class="span2">
									<div class="thumbnail" ng-show="!$flow.files.length">
										<img ng-src="{{profileImage ? '/pimages/' + profileImage : 'http://www.placehold.it/200x150/EFEFEF/AAAAAA&text=no+image'}}" style="width: 150px; height: 150px" flow-btn /> <span style="color: #CFCFCF">(Optional)</span>
									</div>
									<div class="thumbnail" ng-show="$flow.files.length">
										<img flow-img="$flow.files[0]" style="width: 150px; height: 150px" flow-btn />
									</div>
									<div ng-repeat="file in $flow.files">
										<div class="progress" style="width: auto" ng-class="{'progress-success':file.isComplete() ,'progress-bar-info': file.isUploading()}">
											<div class="bar" style="width: {{file.progress()* 100">
												<span>{{(file.progress() * 100).toFixed(0)}}%</span>
											</div>
										</div>
									</div>
									<button type="button" class="btn btn-info " flow-btn>select image</button>
								</div>

							</div>
						</td>
					</tr>
					<tr>
						<td>Assign Unique Name :</td>
						<td><div class="form-inline">
								<input type="hidden" ng-mode="checkName" /> @<input type="text" ng-model="uniqueName" name="uniqueName" placeholder="(Optional)" class="form-control" /> <br /> &nbsp;
								<button type="button" ng-click="checkUniqueName()" class="btn btn-info btn-sm form-control">Check</button>

							</div> <small id="emailHelp" class="form-text text-muted" ng-show="uniqueNameMessage">{{uniqueNameMessage}}</small></td>
					</tr>
					<tr>
						<td>Profile Message :</td>
						<td><div>
								<textarea ng-model="profileMessage" name="message" rows="10" class="form-control" style="min-width: 100%" placeholder="(Optional)"></textarea>
							</div></td>
					</tr>
				</table>
			</div>
		</form>
	</div>
	<hr>

	<footer>
		<p>&copy; Company 2013</p>
	</footer>
</body>
</html>