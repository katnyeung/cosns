<!doctype html>
<html lang="en">
<head>

<script th:include="components/header :: headerLibrary" th:remove="tag"></script>

</head>
<body ng-app="application">
	<script>
		var main = angular.module('application', []);
		main.controller('viewPostController', function($scope, $http, postService, messageService) {
			$scope.shared = messageService.getShared();
			var handleResponse = function(response, type) {
				if (response.data.status == 'success') {
					$scope.message(type + " success");
				} else {
					$scope.message(type + " failed : " + response.data.remarks);
				}
			}

			$scope.likePost = function(postId) {
				postService.likePost(postId).then(function(response) {
					//handleResponse(response, 'like');
				});
			}

			$scope.retweetPost = function(postId) {
				postService.retweetPost(postId).then(function(response) {
					handleResponse(response, 'retweet');
				});
			}

			postService.loadPosts("getUserPosts/[[${targetUser?.userId}]]").then(function(response) {
				$scope.postList = response.data.postList;
			});

			$scope.message = function(message) {
				messageService.setMessage(message);
			}
		});

		main.controller('viewUserController', function($scope, $http, messageService) {
			$scope.shared = messageService.getShared();
			$scope.followedList = {};
			$scope.isFollowed = false;

			if ($scope.shared.user) {
				$scope.followedList = $scope.shared.user.followers;
			}

			$http({
				url : "/user/getUser/[[${targetUser?.userId}]]",
				method : "GET",
				headers : {
					'Content-Type' : 'application/json'
				}
			}).then(function(response) {

				$scope.user = response.data.user;
				
				if (response.data.user.profileImage[0]) {
					$scope.profileImage = response.data.user.profileImage[0].filename;
				}

				angular.forEach($scope.followedList, function(followedUser) {
					if (followedUser.userId === response.data.user.userId) {
						$scope.isFollowed = true;
					}
				});
			});

			$scope.follow = function(userId) {
				$http({
					url : "/user/follow/" + userId,
					method : "GET",
					headers : {
						'Content-Type' : 'application/json'
					}
				}).then(function(response) {
					if (response.data.status == 'success') {
						$scope.message(response.data.remarks);
					} else {
						$scope.message(response.data.remarks);
					}
				});
			}

			$scope.message = function(message) {
				messageService.setMessage(message);
			}
		});
	</script>

	<div th:include="components/post :: viewPostScript" th:remove="tag"></div>
	<div th:include="components/header :: headerScript" th:remove="tag"></div>
	<div th:include="components/header :: headerBody" th:remove="tag"></div>

	<div class="container" ng-controller="viewUserController">
		<div class="hero-unit">
			<img src="/pimages/{{profileImage}}" /><br />
			{{user.uniqueName}} ( {{user.email}} )
			<pre>{{user.message}}</pre>
			<br /> Following
			<ul>
				<li ng-repeat="followedUser in followedList"><a
					href="/u/{{followedUser.uniqueName ? followedUser.uniqueName : followedUser.userId}}">{{followedUser.uniqueName
						? followedUser.uniqueName : followedUser.userId}}</a></li>
			</ul>
			<button type="button"
				th:attr="ng-click='follow('+${targetUser?.userId}+');',ng-show='' + ${user != null && user.userId != targetUser.userId} + ' && !isFollowed'">Follow</button>
		</div>
		<div ng-controller="viewPostController" class="row offset1">
			<div th:include="components/post :: viewPosts" th:remove="tag"></div>
		</div>
	</div>


</body>
</html>