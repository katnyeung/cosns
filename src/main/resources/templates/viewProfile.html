<!doctype html>
<html lang="en">
<head>

<script th:include="components/header :: headerLibrary" th:remove="tag"></script>

</head>
<body ng-app="application">
	<script>
		var main = angular.module('application', [ 'ngSanitize' ]);
		main.controller('viewPostController', function($scope, $http, postService, messageService) {
			postService.setMessageService(messageService);

			$scope.likePost = function(postId) {
				postService.likePost(postId);
			}
			$scope.retweetPost = function(postId) {
				postService.retweetPost(postId);
			}
			$scope.removePost = function(postId) {
				postService.removePost(postId);
			}
			$scope.loadPost = function(handler) {
				postService.loadPosts("getUserPosts/[[${targetUser?.userId}]]", handler);
			}

			var handler = function(postList) {
				$scope.postList = postList;
			}

			$scope.loadPost(handler);

			$scope.shared = messageService.getShared();

			$scope.$watch('shared.user', function(newValue, oldValue) {
				if (newValue != oldValue) {
					$scope.loadPost(handler);
				}
			});

		});

		main.controller('viewUserController', function($scope, $http, messageService) {
			$scope.shared = messageService.getShared();

			$scope.followedList = {};
			$scope.userList = {};
			$scope.isFollowed = false;

			console.log($scope.shared);

			if ($scope.shared.user) {
				$scope.followedList = $scope.shared.user.followers;
			}

			$http({
				url : "/user/getUser/[[${targetUser?.userId}]]",
				method : "GET",
				headers : {
					'Content-Type' : 'application/json'
				}
			}).then(function(response) {

				$scope.user = response.data.user;
				$scope.userMap = response.data.userMap;

				if (response.data.user.profileImage[0]) {
					$scope.profileImage = response.data.user.profileImage[0].filename;
				}

				angular.forEach($scope.followedList, function(followedUser) {
					if (followedUser == response.data.user.userId) {
						$scope.isFollowed = true;
					}
				});
			});

			$scope.follow = function(userId) {
				$http({
					url : "/user/follow/" + userId,
					method : "GET",
					headers : {
						'Content-Type' : 'application/json'
					}
				}).then(function(response) {
					if (response.data.status == 'success') {
						$scope.isFollowed = true;
						$scope.message(response.data.remarks);
					} else {
						$scope.message(response.data.remarks);
					}
				});
			}

			$scope.unfollow = function(userId) {
				$http({
					url : "/user/unfollow/" + userId,
					method : "GET",
					headers : {
						'Content-Type' : 'application/json'
					}
				}).then(function(response) {
					if (response.data.status == 'success') {
						$scope.isFollowed = false;
						messageService.setUser(response.data.user);
						$scope.message(response.data.remarks);
					} else {
						$scope.message(response.data.remarks);
					}
				});
			}
			$scope.message = function(message) {
				messageService.setMessage(message);
			}
		});
	</script>

	<div th:include="components/post :: viewPostScript" th:remove="tag"></div>
	<div th:include="components/header :: headerScript" th:remove="tag"></div>
	<div th:include="components/header :: headerBody" th:remove="tag"></div>

	<div class="container" ng-controller="viewUserController">
		<div class="container">
			<img src="/pimages/{{profileImage}}" class="rounded img-fluid " /><br /> {{user.uniqueName}} ( {{user.email}} )
			<pre>{{user.message}}</pre>
			<br /> Following
			<ul>
				<li ng-repeat="followerId in user.followers"><a href="/u/{{userMap[followerId].uniqueName ? userMap[followerId].uniqueName : userMap[followerId].userId}}">{{userMap[followerId].uniqueName ? userMap[followerId].uniqueName : userMap[followerId].email}}</a></li>
			</ul>
			<button class="btn btn-info" type="button" th:attr="ng-click='follow('+${targetUser?.userId}+');',ng-show='' + ${user != null && user.userId != targetUser.userId} + ' && !isFollowed'">Follow</button>
			<button class="btn btn-warning" type="button" th:attr="ng-click='unfollow('+${targetUser?.userId}+');',ng-show='' + ${user != null && user.userId != targetUser.userId} + ' && isFollowed'">Unfollow</button>

		</div>
		<div ng-controller="viewPostController" class="row-fluid">
			<div ng-repeat="post in postList" class="m-1">
				<hr/>
				<div th:include="components/post :: viewPosts('thumbnail-mid')" th:remove="tag"></div>
			</div>
		</div>
	</div>
	<hr>

	<footer>
		<p>&copy; Company 2013</p>
	</footer>

</body>
</html>