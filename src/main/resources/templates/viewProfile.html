<!doctype html>
<html lang="en">
<head>

<script th:include="components/header :: headerLibrary" th:remove="tag"></script>

</head>
<body ng-app="application">
	<script>
		var main = angular.module('application', []);
		main.controller('viewPostController', function($scope, $http, postService, messageService) {
			$scope.shared = messageService.getShared();
			var handleResponse = function(response, type) {
				if (response.data.status == 'success') {
					$scope.message(type + " success");
				} else {
					$scope.message(type + " failed : " + response.data.remarks);
				}
			}

			$scope.likePost = function(postId) {
				postService.likePost(postId).then(function(response) {
					//handleResponse(response, 'like');
				});
			}

			$scope.retweetPost = function(postId) {
				postService.retweetPost(postId).then(function(response) {
					handleResponse(response, 'retweet');
				});
			}

			postService.loadPosts("getUserPosts/[[${targetUser?.userId}]]").then(function(response) {
				$scope.postList = response.data.postList;
			});

			$scope.message = function(message) {
				messageService.setMessage(message);
			}
		});

		main.controller('viewUserController', function($scope, $http, messageService) {
			$scope.shared = messageService.getShared();
			
			$scope.followedList = {};
			$scope.userList = {};
			$scope.isFollowed = false;

			console.log($scope.shared);
			
			if ($scope.shared.user) {
				$scope.followedList = $scope.shared.user.followers;
			}

			$http({
				url : "/user/getUser/[[${targetUser?.userId}]]",
				method : "GET",
				headers : {
					'Content-Type' : 'application/json'
				}
			}).then(function(response) {

				$scope.user = response.data.user;
				
				$http({
					url : "/user/getUserList",
					method : "POST",
					headers : {
						'Content-Type' : 'application/json'
					},
					data : {
						userIdList : response.data.user.followers
					}
				}).then(function(ulResponse){
					$scope.userMap = ulResponse.data.userMap;
				});
				
				if (response.data.user.profileImage[0]) {
					$scope.profileImage = response.data.user.profileImage[0].filename;
				}

				angular.forEach($scope.followedList, function(followedUser) {
					if (followedUser.userId === response.data.user.userId) {
						$scope.isFollowed = true;
					}
				});
			});

			$scope.follow = function(userId) {
				$http({
					url : "/user/follow/" + userId,
					method : "GET",
					headers : {
						'Content-Type' : 'application/json'
					}
				}).then(function(response) {
					if (response.data.status == 'success') {
						$scope.isFollowed = true;
						$scope.message(response.data.remarks);
					} else {
						$scope.message(response.data.remarks);
					}
				});
			}

			$scope.message = function(message) {
				messageService.setMessage(message);
			}
		});
	</script>

	<div th:include="components/post :: viewPostScript" th:remove="tag"></div>
	<div th:include="components/header :: headerScript" th:remove="tag"></div>
	<div th:include="components/header :: headerBody" th:remove="tag"></div>

	<div class="container" ng-controller="viewUserController">
		<div class="container well">
			<img src="/pimages/{{profileImage}}" class="col-3"/><br />
			{{user.uniqueName}} ( {{user.email}} )
			<pre>{{user.message}}</pre>
			<br /> Following
			<ul>
				<li ng-repeat="followerId in user.followers"><a href="/u/{{userMap[followerId].uniqueName ? userMap[followerId].uniqueName : userMap[followerId].userId}}">{{userMap[followerId].uniqueName ? userMap[followerId].uniqueName : userMap[followerId].email}}</a></li>
			</ul>
			<button type="button"
				th:attr="ng-click='follow('+${targetUser?.userId}+');',ng-show='' + ${user != null && user.userId != targetUser.userId} + ' && !isFollowed'">Follow</button>
		</div>
		<div ng-controller="viewPostController" class="container">
			<div ng-repeat="post in postList" class="card col-md-9 m-1">
				<div th:include="components/post :: viewPosts('thumbnail')" th:remove="tag"></div>
			</div>
		</div>
	</div>
	<hr>

	<footer>
		<p>&copy; Company 2013</p>
	</footer>

</body>
</html>