<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Example - example-ng-submit</title>

<script
	src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular.min.js"></script>
<script src="/js/ng-flow-standalone.min.js"></script>
<link
	href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css"
	rel="stylesheet" />
<style>
.thumbnail {
	max-width: 200px;
	max-height: 150px;
	line-height: 20px;
	margin-bottom: 5px;
}
</style>
</head>
<body ng-app="app">
	<script>
		var app = angular.module('app', [ 'flow' ])

		app.controller('MyCtrl', function($scope, $http) {
			$scope.submit = function(flow) {
				if($scope.postMessage != ''){
					console.log($scope.postMessage);
					console.log(flow.files);
					var fileList = [];
					
					angular.forEach(flow.files, function(value, key) {
						var msg = JSON.parse(value.msg);
						if(msg.status === 'success'){
							fileList.push(msg.filePath);
						}
						console.log(key + ': ' + msg.filePath);
					});
					
					console.log(fileList);
					$http({
						url : "/post/writePost",
						method : "POST",
						headers : {
							'Content-Type' : 'application/json'
						},
						data : {
							'postMessage' : $scope.postMessage,
							'fileList' : fileList
						}
					}).success(function(data, status, headers, config) {
						$scope.status = status;
						alert(data.status + '\n' + data.remarks);

					}).error(function(data, status, headers, config) {
						alert(data.status + '\n' + data.remarks);
					});
				}
				
			}
		});
	</script>
	<div ng-controller="MyCtrl">

		<div class="text">
			<textarea ng-model="postMessage"></textarea>
		</div>
		<form flow-init="{target: '/post/uploadImage', testChunks:false}" flow-files-submitted="$flow.upload()"
			flow-file-success="$file.msg = $message" ng-submit="submit($flow)">

			<div class="alert" flow-drop
				flow-drag-enter="style={border:'4px solid green'}"
				flow-drag-leave="style={}" ng-style="style">Drag And Drop your
				file here
			</div>

			<span class="btn" flow-btn>Select File</span>

			<table>
				<tr ng-repeat="file in $flow.files">
					<td>{{$index+1}}</td>
					<td>{{file.name}}</td>
					<td>{{file.msg}}</td>
					<td><img flow-img="file" /></td>
					<td><a href="#" class="btn btn-danger"
						ng-click="file.cancel()"> Remove </a></td>
				</tr>
			</table>
			<div>
				<button type="submit" class="btn">Upload</button>
			</div>

		</form>
	</div>
</body>
</html>